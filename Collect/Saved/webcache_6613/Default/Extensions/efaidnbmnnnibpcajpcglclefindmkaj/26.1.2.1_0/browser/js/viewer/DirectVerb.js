/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{analytics as e}from"../../../common/analytics.js";import{loggingApi as t}from"../../../common/loggingApi.js";import{dcTabStorage as r}from"../tab-storage.js";import{getSearchParams as o}from"../../../common/util.js";import{getDirectVerbStorageKey as i}from"../../../sw_modules/direct-verb-utils.js";const a=["createpdf","compresspdf","html-to-pdf"];let n=null;const c=async()=>{const e=await(async()=>{if(n)return n;try{const e=await chrome.tabs.getCurrent();n=e?.id||null}catch(e){}return n})();return e?i(e):null};let s=Promise.resolve();export const updateDirectVerbMetrics=(e,o,i,a)=>{const n=(()=>{const e=r.getItem("search")||"";return new URLSearchParams(e).get("directVerbSessionId")})();n&&e&&(s=s.then(async()=>{try{const t=await(async()=>{const e=await c();return e&&(await chrome.storage.session.get(e))[e]||{}})(),r=t[n]||{};if("metadata"===o)t[n]={...r,[e]:i};else{const o=i??Date.now(),c=`${e}_startTime`,s=`${e}_totalTime`;if("end"===a){if(r[c]&&(r[s]=o-r[c],delete r[c]),"filePreview"===e&&r.clickTimestamp_startTime){const e=r.clickTimestamp_startTime;r.totalDirectVerbExecutionTime=o-e}}else r[c]=o;t[n]={...r}}await(async e=>{const t=await c();t&&await chrome.storage.session.set({[t]:e})})(t)}catch(r){t.error({message:"Failed to update direct verb metrics",error:r?.message,name:e})}}))};export const waitForPendingMetricUpdates=()=>s;export const getAcrobatPromotionSource=()=>{const e=r.getItem("search")||"",t=new URLSearchParams(e).get("pdfurl");return o(t).get("acrobatPromotionSource")};export function sendFileBufferToViewerForDirectFlow(t,r,o,i){o.then(e=>{const o=e.downLoadEndTime,a=e.buffer,n=e.buffer.byteLength,c=e.mimeType,s=e.pdffilename||"document.doc";updateDirectVerbMetrics("assetDownloadPreExecution","event",o,"end"),updateDirectVerbMetrics("fileSizePreExecution","metadata",n),t.executeDirectVerb("executeDirectVerb",a,n,s,i,o,c,r.origin)}).catch(t=>{e.event("DCBrowserExt:Viewer:Error:DirectFlow:FileDownload:Failed",{source:getAcrobatPromotionSource()})})}export async function handlePostPDFConversionInDirectFlow(e,t,o){r.setItem("acrobatPromotionWorkflow","preview"),t+=`?pdfurl=${encodeURIComponent(o)}&pdffilename=${encodeURIComponent(e.data.fileName)}`;const i=(await chrome.tabs.getCurrent())?.id;chrome.tabs.update(i,{url:t}),updateDirectVerbMetrics("filePreview","event",Date.now(),"start")}const m=async()=>{chrome.runtime.sendMessage({main_op:"get-welcome-pdf-url"}).then(async e=>{const t=(await chrome.tabs.getCurrent())?.id;chrome.tabs.update(t,{url:e})})};export async function previewOriginalPDF(){try{const e=r.getItem("search");if(e){r.setItem("acrobatPromotionWorkflow","preview");const t=new URLSearchParams(e);t.set("acrobatPromotionWorkflow","preview");const o=`${chrome.runtime.getURL("viewer.html")}?${t.toString()}`,i=(await chrome.tabs.getCurrent())?.id;chrome.tabs.update(i,{url:o})}else await m(),t.error({message:"[Compress PDF Direct Flow] Error in previewOriginalPDF. Missing 'search' parameter in tab storage",error:"originalSearch is null or undefined"})}catch(e){await m(),t.error({message:"[Compress PDF Direct Flow] Error in previewOriginalPDF. Unexpected error while opening Acrobat preview viewer.",error:e})}}export const isDirectFlowWithoutPreview=()=>{const e=r.getItem("acrobatPromotionWorkflow");return a.includes(e)};export async function handleUpsellCloseInDirectFlow(e){a.includes(e?.data?.workflow)&&(r.removeItem("acrobatPromotionWorkflow"),"compresspdf"===e?.data?.workflow?await previewOriginalPDF():await m())}export function isPreviewPostDirectFlow(){return"preview"===r.getItem("acrobatPromotionWorkflow")}